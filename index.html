<script>
let classes = [];

// Ambil data dari Apps Script server
function loadData() {
  if (typeof google !== "undefined" && google.script && google.script.run) {
    google.script.run.withSuccessHandler(function(data){
      classes = Array.isArray(data) ? data : [];
      search(); // update hasil pencarian otomatis
    }).getClasses();
  } else {
    console.warn("google.script.run tidak tersedia. Pastikan dijalankan dari Web App GAS.");
  }
}

// Load data pertama kali dan refresh setiap 30 detik
loadData();
setInterval(loadData, 30000);

// Fungsi untuk escape karakter khusus agar aman di RegExp
function escapeRegExp(text) {
  return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Fungsi search dengan highlight
function search() {
    const homePage = document.getElementById('homePage');
    const resultsPage = document.getElementById('resultsPage');
    
    const activeSearchBox = homePage.style.display === 'none' 
        ? document.getElementById('searchBoxResults') 
        : document.getElementById('searchBox');
    
    const query = activeSearchBox.value.trim();

    // Tampilkan halaman yang sesuai
    if(query.length > 0) {
        homePage.style.display = 'none';
        resultsPage.style.display = 'block';
    } else {
        homePage.style.display = 'block';
        resultsPage.style.display = 'none';
    }

    // Filter hasil
    const lowerQuery = query.toLowerCase();
    const results = classes.filter(c => 
        c.name && c.name.toLowerCase().includes(lowerQuery)
    );

    const container = document.getElementById('results');
    container.innerHTML = '';

    if (query.length > 0 && results.length > 0) {
        const safeRegex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
        results.forEach(c => {
            const div = document.createElement('div');
            div.className = 'result-item';
            const highlightedName = c.name.replace(safeRegex, '<span class="highlight">$1</span>');
            div.innerHTML = `
                <a href="${c.link}" target="_blank">${highlightedName}</a><br>
                <span class="result-desc">${c.desc || ''}</span>
            `;
            container.appendChild(div);
        });
    }
}
</script>
